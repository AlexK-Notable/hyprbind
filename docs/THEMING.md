# HyprBind Dynamic Theme System

## Overview

HyprBind features a dynamic theme system that automatically integrates with Wallust to apply colors extracted from your current wallpaper. This creates a cohesive visual experience that matches your desktop environment.

## Components

### WallustLoader (Task 23)

Loads color palettes from Wallust-generated configuration files.

**Features:**
- Detects Wallust installation
- Parses Hyprland `colors.conf` format
- Fallback to Waybar CSS colors
- Supports all 16 terminal colors
- Smart color mapping with fallbacks

**Usage:**
```python
from hyprbind.theming import WallustLoader, ColorPalette

# Check if Wallust is installed
if WallustLoader.is_installed():
    # Load colors from system
    palette = WallustLoader.load_colors()
    if palette:
        print(f"Background: {palette.background}")
        print(f"Foreground: {palette.foreground}")
        print(f"Accent: {palette.accent}")
```

**Color Sources (in priority order):**
1. `~/.config/hypr/config/colors.conf` (Hyprland format)
2. `~/.config/waybar/colors.css` (CSS custom properties)

### ColorPalette

Data structure representing a color scheme.

**Required Colors:**
- `background` - Main background color
- `foreground` - Main text/foreground color
- `accent` - Accent/highlight color

**Optional Colors:**
- `color0-15` - Terminal color palette (16 colors)

**Methods:**
```python
# Convert to CSS custom properties
css = palette.to_css()

# Convert to dictionary
colors = palette.to_dict()
```

### ThemeManager (Task 24)

Applies color palettes to GTK4 widgets throughout the application.

**Features:**
- Generates CSS from color palettes
- Applies CSS via GtkCssProvider
- Updates theme dynamically without restart
- Fallback to default theme
- Widget-specific styling

**Usage:**
```python
from hyprbind.theming import ThemeManager, WallustLoader

# Create theme manager
manager = ThemeManager()

# Load and apply Wallust colors
palette = WallustLoader.load_colors()
if palette:
    manager.apply_theme(palette)

# Reload theme (useful for live updates)
manager.reload_theme()

# Reset to default theme
manager.apply_theme(None)
```

## Generated CSS

The ThemeManager generates CSS with custom properties and widget styles:

```css
/* Wallust Dynamic Colors */
@define-color background_color #1e1e2e;
@define-color foreground_color #cdd6f4;
@define-color accent_color #89b4fa;
@define-color color0 #45475a;
@define-color color1 #f38ba8;
/* ... more colors ... */

/* Widget Styles */
window {
    background-color: @background_color;
    color: @foreground_color;
}

headerbar {
    background-color: mix(@background_color, @foreground_color, 0.95);
}

.accent {
    color: @accent_color;
}

.success {
    color: @color2;  /* Green */
}
```

## Integration with MainWindow

The theme system is automatically initialized when HyprBind starts:

```python
class MainWindow(Adw.ApplicationWindow):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        # Setup dynamic theming
        self._setup_theming()

        # ... rest of initialization ...

    def _setup_theming(self):
        """Setup dynamic theming with Wallust colors if available."""
        from hyprbind.theming import WallustLoader, ThemeManager

        self.theme_manager = ThemeManager()

        if not WallustLoader.is_installed():
            print("Wallust not installed, using default theme")
            return

        palette = WallustLoader.load_colors()
        if palette:
            success = self.theme_manager.apply_theme(palette)
            if success:
                print("Applied Wallust dynamic colors")
```

## CSS Classes

Use these CSS classes in your widgets to apply themed colors:

- `.accent` - Applies accent color to text
- `.success` - Applies green color (color2) to text

Example:
```python
# Create a button with accent color
button = Gtk.Button(label="Click Me")
button.add_css_class("accent")

# Create a success label
label = Gtk.Label(label="✓ Success")
label.add_css_class("success")
```

## File Formats

### Hyprland colors.conf

```conf
# Generated by Wallust
$background = rgb(1e1e2e)
$foreground = rgb(cdd6f4)
$color0 = rgb(45475a)
$color1 = rgb(f38ba8)
$color4 = rgb(89b4fa)
```

### Waybar colors.css

```css
:root {
    --background: #1e1e2e;
    --foreground: #cdd6f4;
    --accent: #89b4fa;
    --color0: #45475a;
}
```

## Color Fallback Strategy

When loading colors, the system uses smart fallbacks:

**Primary Colors:**
- `background`: Uses `color0` (black) if not defined
- `foreground`: Uses `color7` (white) if not defined
- `accent`: Uses `color4` (blue), then `color1` (red) if not defined

**Terminal Colors:**
- All 16 colors optional
- Used for semantic styling (success, warning, error)

## Testing

### Unit Tests

Run the test suite:
```bash
pytest tests/theming/ -v
```

### Visual Testing

A visual test script is provided:
```bash
python test_theme_visual.py
```

This creates a test window showing:
- Wallust installation status
- Loaded color values
- Theme application status
- Sample themed widgets

## Architecture

```
┌─────────────────┐
│   MainWindow    │
│                 │
│  ┌───────────┐  │
│  │Theme      │  │
│  │Manager    │  │
│  └─────┬─────┘  │
│        │        │
└────────┼────────┘
         │
         ▼
    ┌────────────┐
    │GtkCss      │
    │Provider    │
    └────────────┘
         │
         ▼
    ┌────────────┐
    │Gdk.Display │
    └────────────┘

┌─────────────────┐
│ WallustLoader   │
└────────┬────────┘
         │
         ▼
┌────────────────────┐
│ Configuration      │
│ Files              │
│                    │
│ • colors.conf      │
│ • colors.css       │
└────────────────────┘
```

## Coverage

Both modules achieve 96% test coverage:

- `WallustLoader`: 96% (110 statements, 4 missed)
- `ThemeManager`: 96% (69 statements, 3 missed)

## Future Enhancements

Potential improvements for future tasks:

1. **Live Reload**: Watch color files and auto-update theme
2. **Theme Persistence**: Save/restore user theme preferences
3. **Custom Themes**: Allow manual color palette creation
4. **Theme Profiles**: Multiple named theme configurations
5. **Color Picker**: Visual color selection interface
6. **Preview Mode**: Preview theme before applying

## Dependencies

- GTK4 (gi.repository.Gtk)
- GDK4 (gi.repository.Gdk)
- Wallust (optional, for dynamic colors)
- Python 3.8+ (dataclasses)

## See Also

- [Wallust Documentation](https://github.com/your-wallust-repo)
- [GTK4 CSS Properties](https://docs.gtk.org/gtk4/css-properties.html)
- [Libadwaita Styling](https://gnome.pages.gitlab.gnome.org/libadwaita/doc/main/style-classes.html)
