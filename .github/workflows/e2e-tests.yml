name: E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-gi \
          python3-gi-cairo \
          gir1.2-gtk-4.0 \
          gir1.2-adwaita-1

    - name: Create virtual environment
      run: python -m venv .venv

    - name: Install Python dependencies
      run: |
        source .venv/bin/activate
        pip install --upgrade pip
        pip install -e .[dev]

    - name: Run E2E test suite
      run: |
        source .venv/bin/activate
        ./run_e2e_tests.sh

    - name: Generate coverage report
      if: always()
      run: |
        source .venv/bin/activate
        pytest tests/e2e/ --cov=src/hyprbind --cov-report=xml --cov-report=html
      continue-on-error: true

    - name: Upload coverage to Codecov
      if: always()
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: e2e
        name: e2e-coverage
      continue-on-error: true

    - name: Upload HTML coverage report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: |
          .pytest_cache/
          pytest-report.xml
        retention-days: 30
